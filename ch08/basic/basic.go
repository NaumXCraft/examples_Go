/*  Go-–∫–æ–¥, –∫–æ—Ç–æ—Ä—ã–π –¥–µ–º–æ–Ω—Å—Ç—Ä–∏—Ä—É–µ—Ç, –∫–∞–∫ –±—ã—Å—Ç—Ä–æ –ø–æ—Å—Ç–∞–≤–∏—Ç—å –ª—é–±–æ–π Wireshark-—Ñ–∏–ª—å—Ç—Ä –∑–∞—Ö–≤–∞—Ç–∞ (BPF) –∏ –Ω–∞—á–∞—Ç—å —Å–ª—É—à–∞—Ç—å.
–≠—Ç–æ—Ç –∫–æ–¥ –≤—ã–ø–æ–ª–Ω—è–µ—Ç —Ç—Ä–∏ —à–∞–≥–∞:
* –ù–∞—Ö–æ–¥–∏—Ç —Å–µ—Ç–µ–≤—ã–µ –∏–Ω—Ç–µ—Ä—Ñ–µ–π—Å—ã.
* –û—Ç–∫—Ä—ã–≤–∞–µ—Ç –ø–µ—Ä–≤—ã–π –∏–Ω—Ç–µ—Ä—Ñ–µ–π—Å.
* –ü—Ä–∏–º–µ–Ω—è–µ—Ç —Ñ–∏–ª—å—Ç—Ä.
*/

package main

import (
	"fmt"
	"time"

	"github.com/google/gopacket"
	"github.com/google/gopacket/pcap"
)

// --- –ó–¥–µ—Å—å –≤—ã –∑–∞–¥–∞–µ—Ç–µ —Å–≤–æ–π —Ñ–∏–ª—å—Ç—Ä (Capture Filter/BPF) ---
// –ü–æ–ø—Ä–æ–±—É–π—Ç–µ —Ä–∞—Å–∫–æ–º–º–µ–Ω—Ç–∏—Ä–æ–≤–∞—Ç—å –æ–¥–∏–Ω –∏–∑ –ø—Ä–∏–º–µ—Ä–æ–≤ –∏ –∑–∞–ø—É—Å—Ç–∏—Ç—å –ø—Ä–æ–≥—Ä–∞–º–º—É.
//
// 1. HTTP-—Ç—Ä–∞—Ñ–∏–∫
const filter = "tcp port 80"

// 2. –¢–æ–ª—å–∫–æ ICMP (Ping)
// const filter = "icmp"

// 3. DNS-–∑–∞–ø—Ä–æ—Å—ã
// const filter = "udp port 53"

// 4. –¢—Ä–∞—Ñ–∏–∫ –∫ –∫–æ–Ω–∫—Ä–µ—Ç–Ω–æ–º—É IP
// const filter = "host 8.8.8.8"

// 5. –¢—Ä–∞—Ñ–∏–∫ –æ—Ç –∏–ª–∏ –∫ –æ–ø—Ä–µ–¥–µ–ª–µ–Ω–Ω–æ–º—É MAC-–∞–¥—Ä–µ—Å—É
// const filter = "ether host 00:11:22:33:44:55"
// -----------------------------------------------------------

func main() {
	// 1. –ü–æ–∏—Å–∫ –ø–µ—Ä–≤–æ–≥–æ –¥–æ—Å—Ç—É–ø–Ω–æ–≥–æ —É—Å—Ç—Ä–æ–π—Å—Ç–≤–∞ (–¥–ª—è –ø—Ä–æ—Å—Ç–æ—Ç—ã)
	devices, err := pcap.FindAllDevs()
	if err != nil || len(devices) == 0 {
		fmt.Println("–û—à–∏–±–∫–∞ –ø–æ–∏—Å–∫–∞ –∏–Ω—Ç–µ—Ä—Ñ–µ–π—Å–æ–≤. –£—Å—Ç–∞–Ω–æ–≤–∏—Ç–µ Npcap/libpcap.")
		return
	}
	device := devices[0]

	fmt.Printf("–ò—Å–ø–æ–ª—å–∑—É–µ–º –∏–Ω—Ç–µ—Ä—Ñ–µ–π—Å: %s (%s)\n", device.Name, device.Description)

	// 2. –û—Ç–∫—Ä—ã—Ç–∏–µ –∏–Ω—Ç–µ—Ä—Ñ–µ–π—Å–∞ –¥–ª—è –∑–∞—Ö–≤–∞—Ç–∞
	// snaplen: 65536 (–ø–æ–ª–Ω—ã–π —Ä–∞–∑–º–µ—Ä –ø–∞–∫–µ—Ç–∞), promisc: true (—Ä–µ–∂–∏–º "–≤—Å–µ –≤–∏–∂—É"), timeout: 1s
	handle, err := pcap.OpenLive(device.Name, 65536, true, time.Second)
	if err != nil {
		fmt.Printf("–û—à–∏–±–∫–∞ –æ—Ç–∫—Ä—ã—Ç–∏—è: %v\n", err)
		return
	}
	defer handle.Close()

	// 3. üîë –°–ê–ú–´–ô –í–ê–ñ–ù–´–ô –®–ê–ì: –ü–†–ò–ú–ï–ù–ï–ù–ò–ï BPF-–§–ò–õ–¨–¢–†–ê
	fmt.Printf("–ü–æ–ø—ã—Ç–∫–∞ –ø—Ä–∏–º–µ–Ω–∏—Ç—å —Ñ–∏–ª—å—Ç—Ä: '%s'\n", filter)
	if err := handle.SetBPFFilter(filter); err != nil {
		fmt.Printf("üö´ –û–®–ò–ë–ö–ê —Ñ–∏–ª—å—Ç—Ä–∞: '%s'. –ü—Ä–æ–≤–µ—Ä—å—Ç–µ —Å–∏–Ω—Ç–∞–∫—Å–∏—Å. %v\n", filter, err)
		return
	}
	fmt.Println("‚úÖ –§–∏–ª—å—Ç—Ä –ø—Ä–∏–º–µ–Ω—ë–Ω —É—Å–ø–µ—à–Ω–æ! –ñ–¥—ë–º –ø–∞–∫–µ—Ç—ã...")
	fmt.Println("–ù–∞–∂–º–∏—Ç–µ Ctrl+C –¥–ª—è –æ—Å—Ç–∞–Ω–æ–≤–∫–∏.")

	// 4. –ù–∞—á–∞–ª–æ –∑–∞—Ö–≤–∞—Ç–∞ –∏ –≤—ã–≤–æ–¥ –ø–µ—Ä–≤—ã—Ö 5 –ø–∞–∫–µ—Ç–æ–≤
	packetSource := gopacket.NewPacketSource(handle, handle.LinkType())
	counter := 0
	for packet := range packetSource.Packets() {
		counter++
		fmt.Printf("\n#%d –ó–∞—Ö–≤–∞—á–µ–Ω –ø–∞–∫–µ—Ç! L4/–ü–æ—Ä—Ç—ã: %s\n", counter, packet.TransportLayer())

		if counter >= 5 {
			fmt.Println("\n–ó–∞—Ö–≤–∞—á–µ–Ω–æ 5 –ø–∞–∫–µ—Ç–æ–≤, –æ—Å—Ç–∞–Ω–∞–≤–ª–∏–≤–∞—é.")
			break
		}
	}
}

/* –ö–∞–∫ –≠—Ç–æ –†–∞–±–æ—Ç–∞–µ—Ç:
–ö–ª—é—á–µ–≤–æ–π –º–æ–º–µ–Ω—Ç ‚Äî —ç—Ç–æ –º–µ—Ç–æ–¥ handle.SetBPFFilter(filter).
1. –ì–¥–µ —Å—Ç–∞–≤–∏—Ç—å —Ñ–∏–ª—å—Ç—Ä?
–í—ã –ø—Ä–æ—Å—Ç–æ –º–µ–Ω—è–µ—Ç–µ –∑–Ω–∞—á–µ–Ω–∏–µ –≤ –∫–æ–Ω—Å—Ç–∞–Ω—Ç–µ filter –≤ –Ω–∞—á–∞–ª–µ —Ñ–∞–π–ª–∞:
const filter = "tcp port 80"  <- –ú–µ–Ω—è–µ–º —Ç–æ–ª—å–∫–æ –∑–¥–µ—Å—å!

–í—Å—è –æ—Å—Ç–∞–ª—å–Ω–∞—è –ª–æ–≥–∏–∫–∞ –≤ —Ñ—É–Ω–∫—Ü–∏–∏ main –æ—Å—Ç–∞–µ—Ç—Å—è –Ω–µ–∏–∑–º–µ–Ω–Ω–æ–π.
2. –ö–∞–∫ Go –ø—Ä–∏–º–µ–Ω—è–µ—Ç —Ñ–∏–ª—å—Ç—Ä?
–ö–æ–≥–¥–∞ –∫–æ–¥ –¥–æ—Ö–æ–¥–∏—Ç –¥–æ —Å—Ç—Ä–æ–∫–∏:
if err := handle.SetBPFFilter(filter); err != nil {  ...  }


* Go –ø–µ—Ä–µ–¥–∞–µ—Ç —Ç–µ–∫—Å—Ç–æ–≤—É—é —Å—Ç—Ä–æ–∫—É (–Ω–∞–ø—Ä–∏–º–µ—Ä, "icmp") –±–∏–±–ª–∏–æ—Ç–µ–∫–µ pcap.
* pcap –∫–æ–º–ø–∏–ª–∏—Ä—É–µ—Ç —ç—Ç—É —Å—Ç—Ä–æ–∫—É –≤ —Å–ø–µ—Ü–∏–∞–ª—å–Ω—ã–π –±–∞–π—Ç-–∫–æ–¥ (—ç—Ç–æ –∏ –µ—Å—Ç—å BPF-–ø—Ä–æ–≥—Ä–∞–º–º–∞).
* –î—Ä–∞–π–≤–µ—Ä —Å–µ—Ç–µ–≤–æ–π –∫–∞—Ä—Ç—ã (Npcap/libpcap) –ø–æ–ª—É—á–∞–µ—Ç —ç—Ç–æ—Ç –±–∞–π—Ç-–∫–æ–¥ –∏ –Ω–∞—á–∏–Ω–∞–µ—Ç —Ñ–∏–ª—å—Ç—Ä–æ–≤–∞—Ç—å —Ç—Ä–∞—Ñ–∏–∫ –ø—Ä—è–º–æ –Ω–∞ —É—Ä–æ–≤–Ω–µ —è–¥—Ä–∞ –æ–ø–µ—Ä–∞—Ü–∏–æ–Ω–Ω–æ–π —Å–∏—Å—Ç–µ–º—ã.
–í —Ä–µ–∑—É–ª—å—Ç–∞—Ç–µ, –∫–æ–≥–¥–∞ –≤–∞—à —Ü–∏–∫–ª for packet := range packetSource.Packets() –∑–∞–ø—É—Å–∫–∞–µ—Ç—Å—è, –æ–Ω –≤–∏–¥–∏—Ç —Ç–æ–ª—å–∫–æ —Ç–µ –ø–∞–∫–µ—Ç—ã, –∫–æ—Ç–æ—Ä—ã–µ –ø—Ä–æ—à–ª–∏ —á–µ—Ä–µ–∑ –≤–∞—à —Ñ–∏–ª—å—Ç—Ä. –ï—Å–ª–∏ –≤—ã –ø–æ—Å—Ç–∞–≤–∏–ª–∏ tcp port 80 –∏ –æ—Ç–∫—Ä—ã–ª–∏ —Å–∞–π—Ç –ø–æ HTTP, –≤—ã —É–≤–∏–¥–∏—Ç–µ –ø–∞–∫–µ—Ç—ã. –ï—Å–ª–∏ –≤—ã –ø–æ—Å—Ç–∞–≤–∏–ª–∏ icmp –∏ –Ω–µ –∑–∞–ø—É—Å–∫–∞–ª–∏ Ping, –≤—ã –Ω–µ —É–≤–∏–¥–∏—Ç–µ –Ω–∏—á–µ–≥–æ.

3. –ü—Ä–∏–º–µ—Ä—ã –§–∏–ª—å—Ç—Ä–æ–≤ (Wireshark BPF)
–í—ã –º–æ–∂–µ—Ç–µ –∏—Å–ø–æ–ª—å–∑–æ–≤–∞—Ç—å –ª—é–±—ã–µ Capture Filters –∏–∑ Wireshark:

| –ß—Ç–æ –Ω—É–∂–Ω–æ –ø–æ–π–º–∞—Ç—å      | BPF-—Ñ–∏–ª—å—Ç—Ä                  | –ü–æ—è—Å–Ω–µ–Ω–∏–µ |
|------------------------|-----------------------------|--------------------------------------------------|
| –í–µ—Å—å –≤–µ–±-—Ç—Ä–∞—Ñ–∏–∫        | port 80 or port 443         | TCP –ø–æ—Ä—Ç—ã HTTP –∏ HTTPS.     					  |
| –û—Ç–ø—Ä–∞–≤–∏—Ç–µ–ª—å MAC        | ether src 00:00:5e:00:53:aa | –ü–∞–∫–µ—Ç—ã, –∏—Å—Ö–æ–¥—è—â–∏–µ —Å —ç—Ç–æ–≥–æ MAC-–∞–¥—Ä–µ—Å–∞. 		      |
| –¢–æ–ª—å–∫–æ ARP-–∑–∞–ø—Ä–æ—Å—ã     | arp and arp[7] = 1          | –§–∏–ª—å—Ç—Ä –∫–∞–Ω–∞–ª—å–Ω–æ–≥–æ —É—Ä–æ–≤–Ω—è (L2). 			      |
| –¢—Ä–∞—Ñ–∏–∫ –∫ —Å–µ—Ç–∏ 10.x.x.x | dst net 10.0.0.0/8          | –í–µ—Å—å —Ç—Ä–∞—Ñ–∏–∫, –∏–¥—É—â–∏–π –≤ —Å–µ—Ç—å 10.0.0.0 —Å –º–∞—Å–∫–æ–π /8. |
| –ù–ï DNS (–≤—Å—ë –∫—Ä–æ–º–µ)     | not udp port 53             | –õ–æ–≤–∏—Ç –≤–µ—Å—å —Ç—Ä–∞—Ñ–∏–∫, –∫—Ä–æ–º–µ DNS. 				      |

*/
